<app-gdpr-banner [showBanner]="showGdprBanner"
                 (consentChanged)="onConsentChanged($event)">
</app-gdpr-banner>

<main>

  <h2 class="start">{{ 'USER_PROFILE.PROFILE' | translate }}</h2>

  <!--  Update Profile -->
  <app-profile-update-form></app-profile-update-form>


  <div *ngIf="!consentGiven else favorites">
    <p>{{ 'USER_PROFILE.MSG_NO_GDPR' | translate }}</p>

  </div>

  <ng-template #favorites>
    <app-favorite-drinks> </app-favorite-drinks>
  </ng-template>
  <br>

  <!-- Drink Form Section -->
  <form class="drinkForm" [formGroup]="drinkForm" (ngSubmit)="onSubmit()">

    <div class="form-row">
      <label for="name">{{ 'USER_PROFILE.CREATE_DRINK_NAME' | translate }}</label>
      <input id="name" type="text" formControlName="name" required />
    </div>

    <div class="form-row">
      <label for="category">{{ 'USER_PROFILE.CREATE_DRINK_CATEGORY' | translate }}</label>
      <input id="category" type="text" formControlName="category" required />
    </div>

    <div class="form-row">
      <label for="glass">{{ 'USER_PROFILE.CREATE_DRINK_GLASS' | translate }}</label>
      <select id="glass" formControlName="glassId">
        <option [ngValue]="null" disabled selected>{{ 'USER_PROFILE.CREATE_DRINK_GLASS_DROP' | translate }}</option>
        <option *ngFor="let glass of glassList" [value]="glass.id">{{ glass.name }}</option>
      </select>
    </div>

    <div class="form-row">
      <label for="instructions">{{ 'USER_PROFILE.CREATE_DRINK_INSTRUCTIONS' | translate }}</label>
      <textarea id="instructions" formControlName="instructions" required></textarea>
    </div>

    <div formArrayName="ingredients">
      <div *ngFor="let ingredientCtrl of ingredients.controls; let i = index" [formGroupName]="i" class="form-row ingredient-row">
        <label>{{ 'USER_PROFILE.CREATE_DRINK_INGREDIENT' | translate }}</label>
        <select formControlName="ingredientId" required>
          <option value="">{{ 'USER_PROFILE.CREATE_DRINK_INGREDIENT_DROP' | translate }}</option>
          <option *ngFor="let ing of availableIngredients" [value]="ing.id">{{ ing.name }}</option>
        </select>

        <label>{{ 'USER_PROFILE.CREATE_DRINK_INGREDIENT_AMOUNT' | translate }}</label>
        <input formControlName="amount" placeholder="e.g. 1 oz" required />

        <button type="button" (click)="ingredients.removeAt(i)">
          {{ 'USER_PROFILE.CREATE_DRINK_INGREDIENT_REMOVE' | translate }}
        </button>
      </div>
    </div>

    <div class="form-row">
      <button type="button" (click)="addIngredient()">{{ 'USER_PROFILE.CREATE_DRINK_INGREDIENT_ADD' | translate }}</button>
    </div>

    <div class="form-row">
      <label for="file">{{ 'USER_PROFILE.CREATE_DRINK_IMAGE' | translate }}</label>
      <input id="file" type="file" (change)="onFileSelected($event)" accept="image/*" />
    </div>

    <div class="form-row">
      <button type="submit">{{ 'USER_PROFILE.CREATE_DRINK_CONFIRM_BUTTON' | translate }}</button>
    </div>

  </form>

  <h2 id="created-header">
    {{ 'USER_PROFILE.CREATE_DRINK_CREATED_HEADER' | translate }}
  </h2>

  <!-- Barra di ricerca drink creati -->
  <div style="text-align: center; margin-bottom: 1rem;">
    <input type="text"
           [(ngModel)]="searchQuery"
           (ngModelChange)="onSearchQueryChange()"
           placeholder="{{ 'USER_PROFILE.CREATE_DRINK_CREATED_SEARCH' | translate }}"
           style="padding: 0.5rem; width: 300px; border-radius: 5px; border: 1px solid #ccc;" />
  </div>


  <!-- User Created Drinks -->
  <div class="user-drinks" *ngIf="filteredUserDrinks.length > 0">


    <p-card class="drink-card" *ngFor="let drink of filteredUserDrinks">

      <ng-template #header>
        <img *ngIf="drink.imageUrl"
             [src]="drink.imageUrl"
             alt="{{ drink.name }} image"
             width="200"
             height="200"
             style="object-fit: cover; border-radius: 8px;" />
      </ng-template>

      <ng-template #title id="title">
        {{ drink.name }}
      </ng-template>

      <ng-template #subtitle>
        <ul>
          <li *ngFor="let ingredient of drink.drinkIngredients">
            {{ ingredient.amount }} - {{ ingredient.ingredient?.ingredientName }}
          </li>
        </ul>
      </ng-template>

      <ng-template #footer>
        <p-button class="actionBtn" (click)="addToFavorites(drink.id)"> {{ 'USER_PROFILE.CREATE_DRINK_ADD_FAVORITE' | translate }} </p-button>
        <button class="actionBtn" (click)="onModifyClick(drink)"> {{ 'USER_PROFILE.CREATE_DRINK_MODIFY' | translate }} </button>
        <button class="actionBtn" (click)="deleteDrink(drink.id)"> {{ 'USER_PROFILE.CREATE_DRINK_DELETE' | translate }} </button>
      </ng-template>
    </p-card>

  </div>

  <div *ngIf="filteredUserDrinks.length === 0 ">
    <p>{{ 'USER_PROFILE.CREATE_DRINK_NO_RESULT' | translate }}</p>
  </div>

  <!-- Modify Drink Form (shown as an overlay or inline) -->
  <div class="modify-form-overlay" *ngIf="selectedDrink">
      <h2 class="modifica">{{ 'USER_PROFILE.MODIFY_DRINK_HEADER' | translate }}</h2>
    <div class="modify-form">
      <form [formGroup]="modifyForm" (ngSubmit)="submitModification(selectedDrink.id)">

        <!-- Drink Name -->
        <div class="form-row">
          <label for="mod-name">{{ 'USER_PROFILE.CREATE_DRINK_NAME' | translate }}</label>
          <input id="mod-name" type="text" formControlName="name" required />
        </div>

        <!-- Category -->
        <div class="form-row">
          <label for="mod-category">{{ 'USER_PROFILE.CREATE_DRINK_CATEGORY' | translate }}</label>
          <input id="mod-category" type="text" formControlName="category" required />
        </div>

        <!-- Glass -->
        <div class="form-row">
          <label for="mod-glass">{{ 'USER_PROFILE.CREATE_DRINK_GLASS' | translate }}</label>
          <select id="mod-glass" formControlName="glassId">
            <option [ngValue]="null" disabled selected>{{ 'USER_PROFILE.CREATE_DRINK_GLASS_DROP' | translate }}</option>
            <option *ngFor="let glass of glassList" [value]="glass.id">{{ glass.name }}</option>
          </select>
        </div>

        <!-- Instructions -->
        <div class="form-row">
          <label for="mod-instructions">{{ 'USER_PROFILE.CREATE_DRINK_INSTRUCTIONS' | translate }}</label>
          <textarea id="mod-instructions" formControlName="instructions" required></textarea>
        </div>

        <!-- Ingredients -->
        <div *ngIf="selectedDrink" formArrayName="ingredients">
          <div *ngFor="let ing of modifyIngredients.controls; let i = index"
               [formGroupName]="i"
               class="ingredient-row">
            <div class="ingredient-field">
              <label>{{ 'USER_PROFILE.CREATE_DRINK_INGREDIENT' | translate }}</label>
              <select formControlName="ingredientId">
                <option *ngFor="let option of ingredientOptions" [value]="option.id">{{ option.name }}</option>
              </select>
            </div>

            <div class="ingredient-field">
              <label>{{ 'USER_PROFILE.CREATE_DRINK_INGREDIENT_AMOUNT' | translate }}</label>
              <input formControlName="amount" placeholder="e.g. 1 oz" />
            </div>

            <div class="ingredient-remove">
              <button type="button" (click)="removeModifyIngredient(i)">
                {{ 'USER_PROFILE.CREATE_DRINK_INGREDIENT_REMOVE' | translate }}
              </button>
            </div>
          </div>

          <div class="add-ingredients">
            <button type="button" (click)="addModifyIngredient()">
              {{ 'USER_PROFILE.CREATE_DRINK_INGREDIENT_ADD' | translate }}
            </button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button type="submit">{{ 'USER_PROFILE.MODIFY_DRINK_SAVE' | translate }}</button>
          <button type="button" (click)="cancelModification()">{{ 'USER_PROFILE.MODIFY_DRINK_CANCEL' | translate }}</button>
        </div>
      </form>
    </div>
  </div>

  <app-back-button></app-back-button>

</main>
