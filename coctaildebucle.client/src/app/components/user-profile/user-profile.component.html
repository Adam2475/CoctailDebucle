<app-gdpr-banner [showBanner]="showGdprBanner"
                 (consentChanged)="onConsentChanged($event)">
</app-gdpr-banner>

<main>

  <h2>My Profile</h2>

  <!--  Update Profile -->
  <section class="profile-update">
    <h3>Update Your Information</h3>

    <form [formGroup]="profileForm" (ngSubmit)="onProfileUpdate()">
      <div class="form-row" *ngFor="let field of editableFields">
        <label class="form-label">{{ field.label }}</label>
        <input [type]="field.type"
               [formControlName]="field.controlName"
               [readonly]="!field.editing"
               class="form-control input-fixed" />
        <button type="button" class="edit-btn" (click)="toggleEdit(field)">
          {{ field.editing ? 'Cancel' : 'Edit' }}
        </button>
      </div>

      <!-- gdpr field -->
      <div class="form-row">
        <label class="form-label">GDPR Consent</label>
        <input type="checkbox" formControlName="gdprConsent" />
      </div>

      <!-- password field -->
      <div class="form-row">
        <label class="form-label">Current Password</label>
        <input type="password"
               value="********"
               readonly
               class="form-control input-fixed" />
        <button type="button" class="edit-btn" (click)="togglePasswordEdit()">
          {{ passwordEditMode ? 'Cancel' : 'Edit' }}
        </button>
      </div>

      <div *ngIf="passwordEditMode">
        <div class="form-row">
          <label class="form-label">New Password</label>
          <input type="password" id="newPassword" formControlName="newPassword" class="form-control input-fixed" />
        </div>

        <div class="form-row">
          <label class="form-label">Confirm New Password</label>
          <input type="password" id="confirmNewPassword" formControlName="confirmNewPassword" class="form-control input-fixed" />
          <div *ngIf="passwordMismatch" class="text-danger">Passwords do not match</div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary save-btn" [disabled]="profileForm.invalid">Save Changes</button>
      <div *ngIf="successMessage" class="text-success">{{ successMessage }}</div>
      <div *ngIf="errorMessage" class="text-danger">{{ errorMessage }}</div>
    </form>
  </section>


  <div *ngIf="!consentGiven">
    <p>You need to accept GDPR consent to view your favorite drinks.</p>
  </div>

  <app-favorite-drinks> </app-favorite-drinks>


  <br>

  <div *ngIf="consentGiven">
    <button (click)="withdrawConsent()">Withdraw GDPR Consent</button>
  </div>

  <!-- Drink Form Section -->
  <form class="drinkForm" [formGroup]="drinkForm" (ngSubmit)="onSubmit()">
    <div>
      <label for="name">Drink Name:</label>
      <input id="name" type="text" formControlName="name" required />
    </div>
    <div>
      <label for="category">Category:</label>
      <input id="category" type="text" formControlName="category" required />
    </div>
    <div class="form-group">
      <label for="glass">Select Glass</label>
      <select id="glass" class="form-control" formControlName="glassId">
        <option [ngValue]="null" disabled selected>-- Select a glass --</option>
        <option *ngFor="let glass of glassList" [value]="glass.id">
          {{ glass.name }}
        </option>
      </select>
    </div>
    <div>
      <label for="instructions">Instructions:</label>
      <textarea id="instructions" formControlName="instructions" required></textarea>
    </div>
    <div formArrayName="ingredients">
      <div *ngFor="let ingredientCtrl of ingredients.controls; let i = index" [formGroupName]="i">
        <label for="ingredientId">Ingredient</label>
        <select formControlName="ingredientId" required>
          <option value="">-- Select Ingredient --</option>
          <option *ngFor="let ing of availableIngredients" [value]="ing.id">{{ ing.name }}</option>
        </select>
        <label for="amount">Amount</label>
        <input formControlName="amount" placeholder="e.g. 1 oz" required />
        <p-button type="button" (click)="ingredients.removeAt(i)">Remove</p-button>
      </div>
    </div>
    <button type="button" (click)="addIngredient()">Add Ingredient</button>
    <div>
      <label for="file">Image:</label>
      <input id="file" type="file" (change)="onFileSelected($event)" accept="image/*" />
    </div>
    <button type="submit">Create Drink</button>
  </form>

  <h2 id="created-header">
    Your Created Drinks
  </h2>

  <!-- Barra di ricerca drink creati -->
  <div style="text-align: center; margin-bottom: 1rem;">
    <input type="text"
           [(ngModel)]="searchQuery"
           (ngModelChange)="onSearchQueryChange()"
           placeholder="Search your drinks..."
           style="padding: 0.5rem; width: 300px; border-radius: 5px; border: 1px solid #ccc;" />
  </div>

  <div class="user-drinks" *ngIf="filteredUserDrinks.length > 0">
    <div class="drink-card" *ngFor="let drink of filteredUserDrinks">
      <h3>{{ drink.name }}</h3>

      <ul>
        <li *ngFor="let ingredient of drink.drinkIngredients">
          {{ ingredient.amount }} - {{ ingredient.ingredient?.ingredientName }}
        </li>
      </ul>
      <img *ngIf="drink.imageUrl"
           [src]="drink.imageUrl"
           alt="{{ drink.name }} image"
           width="200"
           height="200"
           style="object-fit: cover; border-radius: 8px;" />
      <button (click)="addToFavorites(drink.id)">Add to Favorites</button>
      <button (click)="onModifyClick(drink)">Modify</button>
      <button (click)="deleteDrink(drink.id)">Delete</button>
    </div>
  </div>

  <div *ngIf="filteredUserDrinks.length === 0 ">
    <p>No drinks found matching your search.</p>
  </div>

  <button (click)="goBack()">Go Back</button>

  <!-- Modify Drink Form (shown as an overlay or inline) -->
  <div class="modify-form-overlay" *ngIf="selectedDrink">
    <div class="modify-form">
      <h2>Modify Drink</h2>
      <form [formGroup]="modifyForm" (ngSubmit)="submitModification(selectedDrink.id)">
        <!-- Drink Name -->
        <div>
          <label for="mod-name">Drink Name:</label>
          <input id="mod-name" type="text" formControlName="name" required />
        </div>

        <!-- Category -->
        <div>
          <label for="mod-category">Category:</label>
          <input id="mod-category" type="text" formControlName="category" required />
        </div>

        <!-- Glass ID -->
        <div class="form-group">
          <label for="mod-glass">Select Glass</label>
          <select id="mod-glass" class="form-control" formControlName="glassId">
            <option [ngValue]="null" disabled selected>-- Select a glass --</option>
            <option *ngFor="let glass of glassList" [value]="glass.id">
              {{ glass.name }}
            </option>
          </select>
        </div>

        <!-- Instructions -->
        <div>
          <label for="mod-instructions">Instructions:</label>
          <textarea id="mod-instructions" formControlName="instructions" required></textarea>
        </div>

        <!-- Modify Ingredients -->
        <div *ngIf="selectedDrink" formArrayName="ingredients">
          <div *ngFor="let ing of modifyIngredients.controls; let i = index" [formGroupName]="i">
            <select formControlName="ingredientId">
              <option *ngFor="let option of ingredientOptions" [value]="option.id">{{ option.name }}</option>
            </select>
            <input formControlName="amount" placeholder="Amount" />
            <button type="button" (click)="removeModifyIngredient(i)">Remove</button>
          </div>
          <button type="button" (click)="addModifyIngredient()">Add Ingredient</button>
        </div>

        <button type="submit">Save Changes</button>
        <button type="button" (click)="cancelModification()">Cancel</button>
      </form>
    </div>
  </div>

</main>
